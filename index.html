<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple scrollbar styling for a better look */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
        }
        #messages-container::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-700 */
            border-radius: 4px;
        }
        #messages-container::-webkit-scrollbar-thumb:hover {
            background: #718096; /* bg-gray-600 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center h-full font-sans">

    <!-- Auth Container -->
    <div id="auth-container" class="w-full max-w-sm mx-auto">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl">
            <h1 class="text-3xl font-bold mb-2 text-center text-blue-400">ChatApp</h1>
            <p class="text-gray-400 mb-6 text-center">Login or create an account to start.</p>
            <form id="auth-form" onsubmit="return false;"> <!-- Prevent default form submission -->
                <div class="mb-4">
                    <label for="email-input" class="sr-only">Email</label>
                    <input type="email" id="email-input" placeholder="Enter your email" autocomplete="email" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                </div>
                <div class="mb-6">
                     <label for="password-input" class="sr-only">Password</label>
                    <input type="password" id="password-input" placeholder="Enter your password" autocomplete="current-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                </div>
                <div class="flex items-center justify-between gap-4">
                    <button id="signInButton" type="button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out">
                        Sign In
                    </button>
                    <button id="signUpButton" type="button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out">
                        Sign Up
                    </button>
                </div>
            </form>
            <p id="auth-error" class="text-red-400 text-sm mt-4 text-center h-5"></p> <!-- For displaying errors -->
        </div>
    </div>


    <!-- Chat Container (Initially Hidden) -->
    <div id="chat-container" class="w-full h-full max-w-4xl mx-auto flex-col p-4 hidden">
        <div class="bg-gray-800 rounded-2xl shadow-2xl flex flex-col w-full h-full">
            <!-- Header -->
            <header class="bg-gray-900/50 p-4 border-b border-gray-700 rounded-t-2xl flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-blue-400">Public Chat Room</h1>
                    <p id="user-id-display" class="text-xs text-gray-400">Logged in as: <span class="font-mono"></span></p>
                </div>
                <button id="signOutButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    Sign Out
                </button>
            </header>

            <!-- Messages Container -->
            <main id="messages-container" class="flex-1 p-6 space-y-4 overflow-y-auto">
                <!-- Messages will be dynamically added here -->
                 <div class="text-center text-gray-500">Loading messages...</div>
            </main>

            <!-- Message Input Form -->
            <footer class="p-4 bg-gray-900/50 border-t border-gray-700 rounded-b-2xl">
                <form id="message-form" class="flex items-center space-x-3">
                    <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                        <span class="sr-only">Send</span>
                    </button>
                </form>
            </footer>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // --- SECTION 1: INITIALIZATION ---
        // Your web app's Firebase configuration
        // PLACEHOLDERS will be replaced by GitHub Actions during deployment
        const firebaseConfig = {
            apiKey: "__API_KEY__",
            authDomain: "__AUTH_DOMAIN__",
            projectId: "__PROJECT_ID__",
            storageBucket: "__STORAGE_BUCKET__",
            messagingSenderId: "__MESSAGING_SENDER_ID__",
            appId: "__APP_ID__",
            measurementId: "__MEASUREMENT_ID__"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null; // Variable to hold the current user's state
        let unsubscribeMessages = null; // To store the unsubscribe function for the messages listener
        console.log("App starting...");

        // --- SECTION 2: UI ELEMENT REFERENCES ---
        const authContainer = document.getElementById('auth-container');
        const chatContainer = document.getElementById('chat-container');
        const signInButton = document.getElementById('signInButton');
        const signUpButton = document.getElementById('signUpButton');
        const signOutButton = document.getElementById('signOutButton');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages-container');
        const userIdDisplay = document.querySelector('#user-id-display span');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const authError = document.getElementById('auth-error');


        // --- SECTION 3: AUTHENTICATION LOGIC ---
        // Listen for authentication state changes
        onAuthStateChanged(auth, (user) => {
            authError.textContent = ''; // Clear errors on state change
            if (user) {
                // User is signed in
                console.log("User is signed in:", user);
                currentUser = user;
                authContainer.style.display = 'none';
                chatContainer.style.display = 'flex'; // Use flex to show the container
                userIdDisplay.textContent = user.email; // Display user's email
                
                // Load messages and listen for new ones
                unsubscribeMessages = loadMessages();

            } else {
                // User is signed out
                console.log("User is signed out");
                currentUser = null;
                authContainer.style.display = 'block';
                chatContainer.style.display = 'none';
                userIdDisplay.textContent = '';
                // Clear password field on sign out for security
                passwordInput.value = '';

                // Unsubscribe from the messages listener to prevent memory leaks
                if (unsubscribeMessages) {
                    unsubscribeMessages();
                }
                 messagesContainer.innerHTML = '<div class="text-center text-gray-500">Sign in to see messages.</div>';
            }
        });

        // Sign Up button event listener
        signUpButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                authError.textContent = 'Please enter both email and password.';
                return;
            }

            authError.textContent = ''; // Clear previous errors
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed up and signed in. The onAuthStateChanged listener will handle the UI change.
                    console.log("Signed up:", userCredential.user);
                })
                .catch((error) => {
                    console.error("Sign up failed:", error);
                    // Provide user-friendly error messages
                    if (error.code === 'auth/email-already-in-use') {
                        authError.textContent = 'This email is already in use.';
                    } else if (error.code === 'auth/weak-password') {
                        authError.textContent = 'Password should be at least 6 characters.';
                    } else {
                        authError.textContent = 'An error occurred during sign up.';
                    }
                });
        });

        // Sign in button event listener
        signInButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;

             if (!email || !password) {
                authError.textContent = 'Please enter both email and password.';
                return;
            }

            authError.textContent = ''; // Clear previous errors
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                     // Signed in. The onAuthStateChanged listener will handle the UI change.
                     console.log("Signed in:", userCredential.user);
                })
                .catch((error) => {
                    console.error("Authentication failed:", error);
                     if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        authError.textContent = 'Invalid email or password.';
                    } else {
                        authError.textContent = 'An error occurred during sign in.';
                    }
                });
        });

        // Sign out button event listener
        signOutButton.addEventListener('click', () => {
            signOut(auth).catch((error) => {
                console.error("Sign out failed:", error);
            });
        });

        // --- SECTION 4: FIRESTORE (DATABASE) LOGIC ---
        
        // Function to send a message
        async function sendMessage(text) {
            if (!currentUser) {
                console.log("Cannot send message, no user logged in.");
                return;
            }
            try {
                await addDoc(collection(db, "messages"), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    text: text,
                    createdAt: serverTimestamp()
                });
                console.log("Message sent successfully!");
            } catch (error) {
                console.error("Error sending message: ", error);
            }
        }

        // Event listener for the message form submission
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText) {
                sendMessage(messageText);
                messageInput.value = ''; // Clear the input field
            }
        });

        // Function to load and display messages in real-time
        function loadMessages() {
            const q = query(collection(db, "messages"), orderBy("createdAt"));

            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                messagesContainer.innerHTML = ''; // Clear old messages
                if (querySnapshot.empty) {
                    messagesContainer.innerHTML = '<div class="text-center text-gray-500">No messages yet. Be the first to say something!</div>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const message = doc.data();
                        const messageElement = createMessageElement(message);
                        messagesContainer.appendChild(messageElement);
                    });
                     // Auto-scroll to the bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, (error) => {
                console.error("Error loading messages:", error);
                messagesContainer.innerHTML = '<div class="text-center text-red-400">Error loading messages.</div>';
            });
            
            return unsubscribe; // Return the function to stop listening
        }

        // Helper function to create an HTML element for a single message
        function createMessageElement(message) {
            const isSentByCurrentUser = message.uid === currentUser.uid;

            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = `flex ${isSentByCurrentUser ? 'justify-end' : 'justify-start'}`;

            const messageDiv = document.createElement('div');
            messageDiv.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-2xl shadow ${isSentByCurrentUser ? 'bg-blue-600 rounded-br-none' : 'bg-gray-700 rounded-bl-none'}`;
            
            const emailSpan = document.createElement('span');
            emailSpan.className = 'block text-xs font-bold text-gray-300 mb-1';
            emailSpan.textContent = isSentByCurrentUser ? 'You' : message.email;

            const textP = document.createElement('p');
            textP.className = 'text-sm text-white';
            textP.textContent = message.text;

            messageDiv.appendChild(emailSpan);
            messageDiv.appendChild(textP);
            wrapperDiv.appendChild(messageDiv);

            return wrapperDiv;
        }

    </script>

</body>
</html>


